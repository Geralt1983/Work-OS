Based on your feedback, there are three potential reasons the notification didn't fire:
 * Race Condition Logic: The previous loop had a bug where it would overwrite the database state if you crossed multiple thresholds at once (e.g., jumping from 0% to 50%), potentially losing the "sent" status.
 * Triage Bypass: If you completed the tasks via Triage or Chat, the pipeline-tools.ts file handles that logic, and it might not have been updated with the notification trigger yet.
 * Missing DB Column: If you didn't run npm run db:push after the last update, the notificationsSent column doesn't exist, causing the server to fail silently when trying to save the sent status.
Here is the comprehensive fix.
1. Fix server/routes.ts (The Loop Logic)
I've rewritten the notification block to be "atomic"â€”it calculates all necessary alerts first, sends them, and then updates the database once. This prevents state overwrites.
// ... imports
import { sendWifeAlert } from "./notification-service";
import { storage, getLocalDateString, calculateEarnedMinutes } from "./storage";

// ... inside app.post("/api/moves/:id/complete") ...

  app.post("/api/moves/:id/complete", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const effortActual = req.body.effortActual ? parseInt(req.body.effortActual) : undefined;
      
      const move = await storage.completeMove(id, effortActual);
      if (!move) return res.status(404).json({ error: "Move not found" });

      // 1. Calculate Score
      const minutes = calculateEarnedMinutes(move.effortEstimate, move.drainType);

      // 2. Log
      let clientName = "No Client";
      if (move.clientId) {
        const client = await storage.getClient(move.clientId);
        if (client) clientName = client.name;
      }
      
      // Sync Memory
      if (clientName !== "No Client") {
         await storage.updateClientMove(clientName, move.id.toString(), move.title);
      }

      const today = getLocalDateString();
      await storage.addCompletedMove(today, {
        moveId: move.id.toString(),
        description: move.title,
        clientName,
        at: new Date().toISOString(),
        source: "moves-ui",
        earnedMinutes: minutes,
      });

      // === 3. SMART NOTIFICATION SYSTEM (FIXED) ===
      try {
        const metrics = await storage.getTodayMetrics();
        const log = await storage.getDailyLog(today);
        const alreadySent = (log?.notificationsSent as number[]) || [];
        const thresholds = [25, 50, 75, 100];
        const toSend: number[] = [];

        // Determine which thresholds we just crossed
        for (const t of thresholds) {
          if (metrics.pacingPercent >= t && !alreadySent.includes(t)) {
            toSend.push(t);
          }
        }

        if (toSend.length > 0) {
          // Only send the HIGHEST threshold to avoid spamming 3 texts at once
          const highest = Math.max(...toSend);
          console.log(`[Notification] Triggering alert for ${highest}%`);
          
          // Fire the alert
          sendWifeAlert(highest, metrics.movesCompleted).catch(err => 
             console.error("[Notification] Failed to send:", err)
          );
          
          // Mark ALL crossed thresholds as sent so we don't retry lower ones
          const newSentList = [...new Set([...alreadySent, ...toSend])];
          await storage.updateDailyLog(today, { notificationsSent: newSentList });
        }
      } catch (err) {
        console.error("[Notification] Logic Error:", err);
        // Don't block the response if notifications fail
      }
      
      res.json(move);
    } catch (error) {
      console.error("Error completing move:", error);
      res.status(500).json({ error: "Failed to complete move" });
    }
  });

2. Fix server/pipeline-tools.ts (The AI Trigger)
We need to apply the exact same logic here so that if the AI completes a task (via Chat or Triage), it also triggers the alert.
// ... imports
import { sendWifeAlert } from "./notification-service";
import { storage, getLocalDateString, calculateEarnedMinutes } from "./storage";

// ... inside executePipelineTool -> case "complete_move"

    case "complete_move": {
      const moveId = args.move_id as number;
      const move = await storage.getMove(moveId);
      if (!move) return { error: `Move ${moveId} not found` };
      
      await storage.completeMove(moveId);
      
      // 1. Calculate Score
      const minutes = calculateEarnedMinutes(move.effortEstimate, move.drainType);
      
      // 2. Log
      let clientName = "No Client";
      if (move.clientId) {
         const client = await storage.getClient(move.clientId);
         if (client) clientName = client.name;
      }
      
      const today = getLocalDateString();
      await storage.addCompletedMove(today, {
        moveId: moveId.toString(),
        description: move.title,
        clientName,
        at: new Date().toISOString(),
        source: "chat",
        earnedMinutes: minutes
      });

      // 3. SMART NOTIFICATION SYSTEM (Copy of routes.ts logic)
      try {
        const metrics = await storage.getTodayMetrics();
        const log = await storage.getDailyLog(today);
        const alreadySent = (log?.notificationsSent as number[]) || [];
        const thresholds = [25, 50, 75, 100];
        const toSend: number[] = [];

        for (const t of thresholds) {
          if (metrics.pacingPercent >= t && !alreadySent.includes(t)) {
            toSend.push(t);
          }
        }

        if (toSend.length > 0) {
          const highest = Math.max(...toSend);
          console.log(`[Notification] AI Triggering alert for ${highest}%`);
          sendWifeAlert(highest, metrics.movesCompleted).catch(console.error);
          const newSentList = [...new Set([...alreadySent, ...toSend])];
          await storage.updateDailyLog(today, { notificationsSent: newSentList });
        }
      } catch (e) { console.error("[Notification] Error in pipeline tool:", e); }

      return { success: true, message: `Completed "${move.title}"`, move: { ...move, status: "done" } };
    }

3. Verification Step
Since we added a new column (notificationsSent) recently, please run this command in the Shell tab to ensure your database is actually ready to store this data:
npm run db:push

If you don't do this, the storage.updateDailyLog call will fail, and the "sent" status won't be saved, potentially causing duplicate alerts later.
